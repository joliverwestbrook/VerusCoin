stages:
- build
- test
- deploy
########################################################################################################################
####START####                                     PROJECT LEVEL VARIABLES                                  ####START####
########################################################################################################################
variables:
  VERSION: 0.5.7
  VERUS_CLI_LINUX: Verus-CLI-Linux-v${VERSION}.tar.gz
  VERUS_CLI_WINDOWS: Verus-CLI-Windows-v${VERSION}.zip
  VERUS_CLI_MACOS: Verus-CLI-MacOS-v${VERSION}.tar.gz
  DOWNSTREAM_AGAMA_BRANCH: ${CI_COMMIT_REF_NAME}
  POST_MESSAGE: "Source: ${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME}\n
  Pipeline Trigger: ${CI_PIPELINE_SOURCE}\n
  Commit: https://github.com/VerusCoin/VerusCoin/commit/${CI_COMMIT_SHA}\n
  ${CI_COMMIT_MESSAGE}"
########################################################################################################################
####END####                                        PROJECT LEVEL VARIABLES                                   ####END####
########################################################################################################################
########################################################################################################################
########################################################################################################################
####START####          Build Stage: compile and package komodo binaries for Verus CLI                     ####START#####
########################################################################################################################
########################################################################################################################
####START####                                            LINUX                                             ####START####
########################################################################################################################
build:linux:centos7:
  image: asherd/verus-builders:verus-centos
  variables:
    DOCKER_DRIVER: overlay2
    STATIC_LIBCURL: 1
  stage: build
  cache:
    key: "${CI_JOB_NAME}${CI_COMMIT_REF_NAME}"
    paths:
    - depends/built
  script:
  - scl enable devtoolset-7 sh
  - source /opt/rh/devtoolset-7/enable
  - zcutil/build.sh -j$(nproc)
  - mkdir verus-cli
  - cp src/komodod
      src/komodo-cli
      src/fiat/verus
      src/verusd
      doc/man/verus-cli/linux/README.txt
      zcutil/fetch-params.sh
      verus-cli
  - mv verus-cli/fetch-params.sh verus-cli/fetch-params
  - chmod +x verus-cli/komodod
  - chmod +x verus-cli/komodo-cli
  - chmod +x verus-cli/verus
  - chmod +x verus-cli/verusd
  - chmod +x verus-cli/fetch-params
  - if [ "${CI_COMMIT_REF_NAME}" = "master" ]; then strip -g verus-cli/komodod && strip -g verus-cli/komodod; fi
  - tar -czvf ${VERUS_CLI_LINUX} verus-cli
  - sha256sum ${VERUS_CLI_LINUX} > ${VERUS_CLI_LINUX}.sha256
  after_script:
  - curl -F file=@"${VERUS_CLI_LINUX}"
      -F channels="${CLI_POST_CHANNEL}"
      -F initial_comment="${POST_MESSAGE}"
      -H "${SLACK_BOT_AUTH}"
      "https://slack.com/api/files.upload"
  artifacts:
    paths:
    - ${VERUS_CLI_LINUX}
    - ${VERUS_CLI_LINUX}.sha256
    expire_in: 1 week


linux:ubuntu-xenial:
  image: ubuntu:xenial
  variables:
    DOCKER_DRIVER: overlay2
  stage: build
  before_script:
    - apt-get update
    - apt-get -y install
        pkg-config
        libc6-dev
        m4
        autoconf
        curl
        libtool
        make
        ncurses-dev
        unzip
        python
        zlib1g-dev
        wget
        bsdmainutils
        automake
        libssl-dev
        libprotobuf-dev
        protobuf-compiler
        libqrencode-dev
        libdb++-dev
        libgconf-2-4
        libcurl4-openssl-dev
  script:
    - zcutil/build.sh -j$(nproc)
    - mkdir verus-cli
    - cp src/komodod
        src/komodo-cli
        src/fiat/verus
        src/verusd
        doc/man/verus-cli/linux/README.txt
        zcutil/fetch-params.sh
        verus-cli
    - mv verus-cli/fetch-params.sh verus-cli/fetch-params
    - chmod +x verus-cli/komodod
    - chmod +x verus-cli/komodo-cli
    - chmod +x verus-cli/verus
    - chmod +x verus-cli/verusd
    - chmod +x verus-cli/fetch-params
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  artifacts:
    paths: [log.txt]
    expire_in: 1 week

linux:ubuntu-bionic:
  image: ubuntu:bionic
  variables:
    DOCKER_DRIVER: overlay2
  stage: build
  before_script:
    - apt-get update
    - apt-get -y install
        pkg-config
        libc6-dev
        m4
        autoconf
        curl
        libtool
        make
        ncurses-dev
        unzip
        python
        zlib1g-dev
        wget
        bsdmainutils
        automake
        libssl-dev
        libprotobuf-dev
        protobuf-compiler
        libqrencode-dev
        libdb++-dev
        libgconf-2-4
        libcurl4-openssl-dev

  script:
    - zcutil/build.sh -j$(nproc)
    - mkdir verus-cli
    - cp src/komodod
      src/komodo-cli
      src/fiat/verus
      src/verusd
      doc/man/verus-cli/linux/README.txt
      zcutil/fetch-params.sh
      verus-cli
    - mv verus-cli/fetch-params.sh verus-cli/fetch-params
    - chmod +x verus-cli/komodod
    - chmod +x verus-cli/komodo-cli
    - chmod +x verus-cli/verus
    - chmod +x verus-cli/verusd
    - chmod +x verus-cli/fetch-params
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  artifacts:
    paths: [log.txt]
    expire_in: 1 week


linux:ubuntu-cosmic:
  image: ubuntu:cosmic
  variables:
    DOCKER_DRIVER: overlay2
  stage: build
  before_script:
    - apt-get update
    - apt-get -y install
        pkg-config
        libc6-dev
        m4
        autoconf
        curl
        libtool
        make
        ncurses-dev
        unzip
        python
        zlib1g-dev
        wget
        bsdmainutils
        automake
        libssl-dev
        libprotobuf-dev
        protobuf-compiler
        libqrencode-dev
        libdb++-dev
        libgconf-2-4
        gcc-7
        g++-7
        libcurl4-openssl-dev
    - update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 60 --slave /usr/bin/g++ g++ /usr/bin/g++-7
  script:
    - zcutil/build.sh -j$(nproc)
    - mkdir verus-cli
    - cp src/komodod
        src/komodo-cli
        src/fiat/verus
        src/verusd
        doc/man/verus-cli/linux/README.txt
        zcutil/fetch-params.sh
        verus-cli
    - mv verus-cli/fetch-params.sh verus-cli/fetch-params
    - chmod +x verus-cli/komodod
    - chmod +x verus-cli/komodo-cli
    - chmod +x verus-cli/verus
    - chmod +x verus-cli/verusd
    - chmod +x verus-cli/fetch-params
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  artifacts:
    paths: [log.txt]
    expire_in: 1 week

linux:ubuntu-disco:
  image: ubuntu:disco
  variables:
    DOCKER_DRIVER: overlay2
  stage: build
  before_script:
    - apt-get update
    - apt-get -y install
      pkg-config
      libc6-dev
      m4
      autoconf
      curl
      libtool
      make
      ncurses-dev
      unzip
      python
      zlib1g-dev
      wget
      bsdmainutils
      automake
      libssl-dev
      libprotobuf-dev
      protobuf-compiler
      libqrencode-dev
      libdb++-dev
      libgconf-2-4
      gcc-7
      g++-7
      libcurl4-openssl-dev
    - update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 60 --slave /usr/bin/g++ g++ /usr/bin/g++-7
  script:
    - zcutil/build.sh -j$(nproc)
    - mkdir verus-cli
    - cp src/komodod
      src/komodo-cli
      src/fiat/verus
      src/verusd
      doc/man/verus-cli/linux/README.txt
      zcutil/fetch-params.sh
      verus-cli
    - mv verus-cli/fetch-params.sh verus-cli/fetch-params
    - chmod +x verus-cli/komodod
    - chmod +x verus-cli/komodo-cli
    - chmod +x verus-cli/verus
    - chmod +x verus-cli/verusd
    - chmod +x verus-cli/fetch-params
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  artifacts:
    paths: [log.txt]
    expire_in: 1 week


linux:fedora-30:
  image: fedora:30
  variables:
    DOCKER_DRIVER: overlay2
  stage: build
  before_script:
    - dnf -y update
    - dnf -y install
        autoconf
        libtool
        unzip
        epel-release
        git
        python
        python34-devel
        make
        wget
        curl-devel
        automake
        gcc
        gcc-c++
        patch
        which
        glibc-static
        libstdc++-static
        lbzip2

  script:
    - zcutil/build.sh -j$(nproc)
    - mkdir verus-cli
    - cp src/komodod
        src/komodo-cli
        src/fiat/verus
        src/verusd
        doc/man/verus-cli/linux/README.txt
        zcutil/fetch-params.sh
        verus-cli
    - mv verus-cli/fetch-params.sh verus-cli/fetch-params
    - chmod +x verus-cli/komodod
    - chmod +x verus-cli/komodo-cli
    - chmod +x verus-cli/verus
    - chmod +x verus-cli/verusd
    - chmod +x verus-cli/fetch-params
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  artifacts:
    paths: [log.txt]
    expire_in: 1 week


linux:fedora-29:
  image: fedora:29
  variables:
    DOCKER_DRIVER: overlay2
  stage: build
  before_script:
    - dnf -y update
    - dnf -y install
      git
      pkgconfig
      automake
      make
      autoconf
      ncurses-devel
      python
      python-zmq
      wget
      curl
      libcurl-devel
      gtest-devel
      gcc
      gcc-c++
      libtool
      patch
      bzip2
      glibc-static
      libstdc++-static

  script:
    - zcutil/build.sh -j$(nproc)
    - mkdir verus-cli
    - cp src/komodod
      src/komodo-cli
      src/fiat/verus
      src/verusd
      doc/man/verus-cli/linux/README.txt
      zcutil/fetch-params.sh
      verus-cli
    - mv verus-cli/fetch-params.sh verus-cli/fetch-params
    - chmod +x verus-cli/komodod
    - chmod +x verus-cli/komodo-cli
    - chmod +x verus-cli/verus
    - chmod +x verus-cli/verusd
    - chmod +x verus-cli/fetch-params
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  artifacts:
    paths: [log.txt]
    expire_in: 1 week



########################################################################################################################
####END####                                              LINUX                                               ####END####
########################################################################################################################
####START####                                           WINDOWS                                            ####START####
########################################################################################################################
build:windows:
  image: asherd/verus-builders:verus-windows
  variables:
    DOCKER_DRIVER: overlay2
  stage: build
  cache:
    key: "${CI_JOB_NAME}${CI_COMMIT_REF_NAME}"
    paths:
    - depends/built
  script:
  - zcutil/build-win.sh -j$(nproc)
  - mkdir verus-cli
  - cp src/komodod.exe
      src/komodo-cli.exe
      src/komodo-tx.exe
      src/fiat/verus.bat
      src/verusd.bat
      doc/man/verus-cli/windows/README.txt
      zcutil/fetch-params.bat
      zcutil/wget64.exe
      verus-cli
  - if [ "${CI_COMMIT_REF_NAME}" = "master" ]; then strip -g verus-cli/komodod.exe && strip -g verus-cli/komodod.exe && strip -g verus-cli/komodo-tx.exe; fi
  - zip -r ${VERUS_CLI_WINDOWS} verus-cli
  - sha256sum ${VERUS_CLI_WINDOWS} > ${VERUS_CLI_WINDOWS}.sha256
  - curl -F file=@"${VERUS_CLI_WINDOWS}"
      -F channels="${CLI_POST_CHANNEL}"
      -F initial_comment="${POST_MESSAGE}"
      -H "${SLACK_BOT_AUTH}"
      "https://slack.com/api/files.upload"
  artifacts:
    paths:
    - ${VERUS_CLI_WINDOWS}
    - ${VERUS_CLI_WINDOWS}.sha256
    expire_in: 1 week
########################################################################################################################
####END####                                             WINDOWS                                              ####END####
########################################################################################################################
####START####                                            MACOS                                             ####START####
########################################################################################################################
build:mac:
  stage: build
  tags: ["High Sierra"]
  cache:
    key: "${CI_JOB_NAME}${CI_COMMIT_REF_NAME}"
    paths:
    - depends/built
  script:
  - zcutil/build-mac.sh -j$(sysctl -n hw.physicalcpu)
  - ./makeReleaseMac.sh
  - tar -czvf ${VERUS_CLI_MACOS} verus-cli
  - shasum -a 256 ${VERUS_CLI_MACOS} > ${VERUS_CLI_MACOS}.sha256
  - curl -F file=@"${VERUS_CLI_MACOS}"
      -F channels="${CLI_POST_CHANNEL}"
      -F initial_comment="${POST_MESSAGE}"
      -H "${SLACK_BOT_AUTH}"
      "https://slack.com/api/files.upload"
  artifacts:
    paths:
    - ${VERUS_CLI_MACOS}
    - ${VERUS_CLI_MACOS}.sha256
    expire_in: 1 week
########################################################################################################################
####END####                                              MACOS                                               ####END####
########################################################################################################################
########################################################################################################################
####END####                                           Build Stage                                            ####END####
########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################
####START####     Test stage: Test functionality of komodo binaries. Produce code quality and SAST reports. ####START####
########################################################################################################################
########################################################################################################################
########################################################################################################################
####START####                                        Code Quality                                          ####START####
########################################################################################################################
.code_quality:
  image: docker:stable
  variables:
    DOCKER_DRIVER: overlay2
  allow_failure: true
  services:
  - docker:stable-dind
  script:
  - export SP_VERSION=$(echo "$CI_SERVER_VERSION" | sed 's/^\([0-9]*\)\.\([0-9]*\).*/\1-\2-stable/')
  - docker run
      --env SOURCE_CODE="$PWD"
      --volume "$PWD":/code
      --volume /var/run/docker.sock:/var/run/docker.sock
      "registry.gitlab.com/gitlab-org/security-products/codequality:$SP_VERSION" /code
  artifacts:
    paths: [gl-code-quality-report.json]
########################################################################################################################
####END####                                          Code Quality                                            ####END####
########################################################################################################################
########################################################################################################################
####START####                              Static Application Security Tests                               ####START####
########################################################################################################################
.sast:
  image: docker:stable
  variables:
    DOCKER_DRIVER: overlay2
  allow_failure: true
  services:
  - docker:stable-dind
  script:
  - export SP_VERSION=$(echo "$CI_SERVER_VERSION" | sed 's/^\([0-9]*\)\.\([0-9]*\).*/\1-\2-stable/')
  - docker run
      --env SAST_CONFIDENCE_LEVEL="${SAST_CONFIDENCE_LEVEL:-3}"
      --volume "$PWD:/code"
      --volume /var/run/docker.sock:/var/run/docker.sock
      "registry.gitlab.com/gitlab-org/security-products/sast:$SP_VERSION" /app/bin/run /code
  artifacts:
    paths: [gl-sast-report.json]
########################################################################################################################
####END####                                Static Application Security Tests                                 ####END####
########################################################################################################################
########################################################################################################################
####START####                            Run Verus CLI on Ubuntu Xenial (16.04)                            ####START####
########################################################################################################################
ubuntu:xenial:
  image: ubuntu:xenial
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
  - apt update && apt install -y wget  python libgomp1
  - rm -rf /root/.komodo || true
  - mv .komodo /root/ || true
  script:
  - tar -xzvf ${VERUS_CLI_LINUX}
  - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
  - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
  - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
  - build:linux:centos7
########################################################################################################################
####END####                               Run Verus CLI on Ubuntu Xenial (16.04)                             ####END####
########################################################################################################################
########################################################################################################################
####START####                             Run Verus CLI on Ubuntu Bionic (18.04)                           ####START####
########################################################################################################################
ubuntu:bionic:
  image: ubuntu:bionic
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
  - apt update && apt install -y wget python libgomp1
  - rm -rf /root/.komodo || true
  - mv .komodo /root/ || true
  script:
  - tar -xzvf ${VERUS_CLI_LINUX}
  - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
  - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
  - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7


ubuntu:cosmic:
  image: ubuntu:cosmic
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - apt update && apt install -y wget python libgomp1
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7


ubuntu:disco:
  image: ubuntu:disco
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - apt update && apt install -y wget python libgomp1
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7


debian:jessie:
  image: debian:jessie
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - apt update && apt install -y wget python libgomp1
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7

debian:stretch:
  image: debian:stretch
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - apt update && apt install -y wget python libgomp1
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7


debian:buster:
  image: debian:buster
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - apt update && apt install -y -q wget python libgomp1
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7


centos:7:
  image: centos:7
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - yum update -y -q -e 0 && yum install -y -q -e 0 wget python
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7

fedora:30:
  image: fedora:30
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - yum update -y -q -e 0 && yum install -y -q -e 0 wget python
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7


opensuse:tumbleweed:
  image: opensuse/tumbleweed:latest
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - rpm update -y -q -e 0 && rpm install -y wget python
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7


opensuse:leap:
  image: opensuse/leap:latest
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - rpm update -y -q -e 0 && rpm install -y -q -e 0 wget python
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7

fedora:29:
  image: fedora:29
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  before_script:
    - yum update -y -q -e 0 && yum -y -q -e 0 install -y wget python
    - rm -rf /root/.komodo || true
    - mv .komodo /root/ || true
  script:
    - tar -xzvf ${VERUS_CLI_LINUX}
    - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
    - python qa/verus-cli-tests/verus-cli-tester.py
  after_script:
    - mv /root/.komodo ./ || true
  cache:
    key: ${CI_JOB_NAME}
    paths: [.komodo]
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
    - build:linux:centos7
########################################################################################################################
####END####                               Run Verus CLI on Ubuntu Bionic (18.04)                             ####END####
########################################################################################################################
########################################################################################################################
####START####                             Run Verus CLI on MacOS Sierra (10.12.6)                          ####START####
########################################################################################################################
.macos:sierra:
  stage: test
  tags: ["Sierra"]
  script:
  - tar -xzvf $VERUS_CLI_MACOS
  - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
  - python qa/verus-cli-tests/verus-cli-tester.py
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
  - build:mac
########################################################################################################################
####END####                               Run Verus CLI on MacOS Sierra (10.12.6)                            ####END####
########################################################################################################################
########################################################################################################################
####START####                          Run Verus CLI on MacOS High Sierra (10.12.6)                        ####START####
########################################################################################################################
.macos:high-sierra:
  stage: test
  tags: ["High Sierra"]
  script:
  - tar -xzvf ${VERUS_CLI_MACOS}
  - export PATH=$PATH:$CI_PROJECT_DIR/verus-cli
  - python qa/verus-cli-tests/verus-cli-tester.py
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
  - build:mac
########################################################################################################################
####START####                          Run Verus CLI on MacOS High Sierra (10.12.6)                        ####START####
########################################################################################################################
########################################################################################################################
####START####                              Run Verus CLI on Windows 10                                     ####START####
########################################################################################################################
.windows:10:
  stage: test
  tags: ["Windows 10"]
  script:
  - PowerShell Expand-Archive -Path %VERUS_CLI_WINDOWS% -DestinationPath %CI_PROJECT_DIR%
  - set PATH=%PATH%;%CI_PROJECT_DIR%\verus-cli
  - qa\verus-cli-tests\verus-cli-tester.py
  artifacts:
    paths: [log.txt]
    expire_in: 1 week
  dependencies:
  - build:windows
########################################################################################################################
####END####                                Run Verus CLI on Windows 10                                       ####END####
########################################################################################################################
########################################################################################################################
####END####                                           Test Stage                                             ####END####
########################################################################################################################
########################################################################################################################
####START####                                         Deploy                                               ####START####
########################################################################################################################
deploy:
  stage: deploy
  image: google/cloud-sdk:alpine
  variables:
    DOCKER_DRIVER: overlay2
  dependencies:
  - build:linux:centos7
  - build:windows
  - build:mac
  script:
  - mkdir Windows && mkdir Linux && mkdir MacOS &&
    mv ${VERUS_CLI_WINDOWS} Windows &&
    mv ${VERUS_CLI_LINUX} Linux &&
    mv ${VERUS_CLI_MACOS} MacOS
  - echo "$AUTH_KEY" > AUTH_KEY.json &&
    gcloud auth activate-service-account
    --key-file AUTH_KEY.json
  - gsutil cp -r Windows MacOS Linux  $STAGING/${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME}
  - curl -X POST
      -F token="$CI_JOB_TOKEN"
      -F ref="$DOWNSTREAM_AGAMA_BRANCH"
      -F variables\[UPSTREAM_TRIGGER\]="${CI_PROJECT_NAME}"
      -F variables\[UPSTREAM_CLI_BRANCH\]="${CI_COMMIT_REF_NAME}"
      -F variables\[VERUS_CLI_LINUX\]="${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME}/Linux/${VERUS_CLI_LINUX}"
      -F variables\[VERUS_CLI_WINDOWS\]="${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME}/Windows/${VERUS_CLI_WINDOWS}"
      -F variables\[VERUS_CLI_MACOS\]="${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME}/MacOS/${VERUS_CLI_MACOS}"
      "https://gitlab.com/api/v4/projects/10027007/trigger/pipeline"
########################################################################################################################
####END####                                           Deploy                                                 ####END####
########################################################################################################################
